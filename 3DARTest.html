<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>AR Menu • Model Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root { --bg:#f6f3ef; --ink:#1f2937; --brand:#511c28; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--ink); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { min-height:100%; display:grid; grid-template-rows:auto 1fr auto; }
    header,footer { background:white; border-bottom:1px solid #e5e7eb; padding:10px 14px; }
    footer { border-top:1px solid #e5e7eb; border-bottom:none; color:#6b7280; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:600; }
    .dot { width:28px; height:28px; border-radius:10px; background:var(--brand); color:#fff; display:grid; place-items:center; font-weight:700; }
    .panel { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="text"] { width:min(60vw,520px); padding:8px 10px; border:1px solid #d1d5db; border-radius:10px; }
    button, a.btn { appearance:none; border:1px solid #d1d5db; background:white; padding:8px 12px; border-radius:10px; cursor:pointer; }
    button.primary, a.btn.primary { background:#4f46e5; color:white; border-color:#4f46e5; }
    .content { padding:14px; display:grid; gap:12px; }
    model-viewer { width:100%; height:min(70vh, 680px); background:#fff; border-radius:12px; }
    .note { font-size:12px; color:#6b7280; }
    .alert { padding:8px 10px; border-radius:10px; font-size:13px; }
    .alert.err { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .alert.ok { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    code { background:#f3f4f6; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row" style="justify-content:space-between;">
        <div class="brand">
          <div class="dot">7</div>
          <div>Seven — 3D-модель (HTML-прототип)</div>
        </div>
        <div class="panel">
          <a id="arBtn" class="btn primary" href="#" rel="ar">Посмотреть в AR</a>
        </div>
      </div>
    </header>

    <main class="content">
      <!-- Вьювер -->
      <model-viewer
        id="mv"
        ar
        ar-modes="webxr scene-viewer quick-look"
        camera-controls
        auto-rotate
        shadow-intensity="0.8"
        exposure="1"
        alt="Dish 3D">
      </model-viewer>

      <!-- Статус -->
      <div id="status" class="alert ok" hidden>Готово</div>

      <!-- Управление -->
      <div class="row">
        <input id="urlGlb" type="text" placeholder="GLB URL" />
        <input id="urlUsdz" type="text" placeholder="USDZ URL (iOS)" />
        <button id="loadBtn" class="primary">Загрузить</button>
        <button id="astrBtn">Astronaut (тест)</button>
        <button id="bustBtn">Сброс кэша</button>
      </div>

      <div class="note">
        Подсказки:<br/>
        — Если видишь <b>серый силуэт</b>, модель загрузилась, но <b>текстуры недоступны</b> (не встроены или отсутствуют рядом с GLB).<br/>
        — Лучший фикс: экспортировать GLB с <b>вшитыми текстурами</b> (Blender → External Data → Pack Resources → Export .glb).<br/>
        — Можно передать параметры через URL: <code>?src=GLB&usdz=USDZ</code><br/>
        Пример: <code>?src=https://askento42.github.io/AR-android/scene.glb&usdz=https://askento42.github.io/AR-android/soup_tureen1.usdz</code>
      </div>
    </main>

    <footer>
      <div>Проверка: GitHub Pages + <code>&lt;model-viewer&gt;</code>. Если тут цвет есть, проблема была не в коде приложения.</div>
    </footer>
  </div>

  <script>
    // --- Значения по умолчанию (твои URL) ---
    const DEFAULTS = {
      glb: "https://askento42.github.io/AR-android/scene.glb",
      usdz: "https://askento42.github.io/AR-android/soup_tureen1.usdz",
    };
    const FALLBACK = {
      glb: "https://modelviewer.dev/shared-assets/models/Astronaut.glb",
      usdz: "https://modelviewer.dev/shared-assets/models/Astronaut.usdz",
    };

    const qs = new URLSearchParams(location.search);
    const initialGlb = qs.get("src") || DEFAULTS.glb;
    const initialUsdz = qs.get("usdz") || DEFAULTS.usdz;

    const mv = document.getElementById("mv");
    const urlGlb = document.getElementById("urlGlb");
    const urlUsdz = document.getElementById("urlUsdz");
    const loadBtn = document.getElementById("loadBtn");
    const astrBtn = document.getElementById("astrBtn");
    const bustBtn = document.getElementById("bustBtn");
    const status = document.getElementById("status");
    const arBtn = document.getElementById("arBtn");

    function setStatus(msg, ok = true) {
      status.textContent = msg;
      status.hidden = false;
      status.className = "alert " + (ok ? "ok" : "err");
    }

    function setSrc(glb, usdz) {
      mv.src = glb;
      if (usdz) {
        mv.setAttribute("ios-src", usdz);
        arBtn.href = usdz; // для iOS Quick Look
      } else {
        mv.removeAttribute("ios-src");
        arBtn.href = glb; // для Android Scene Viewer
      }
    }

    function withBust(u) {
      if (!u) return "";
      return u.includes("?") ? `${u}&v=${Date.now()}` : `${u}?v=${Date.now()}`;
    }

    // Инициализация
    urlGlb.value = initialGlb;
    urlUsdz.value = initialUsdz || "";
    setSrc(initialGlb, initialUsdz);
    setStatus("Загружаю модель…");

    // Слушатели событий на model-viewer
    mv.addEventListener("load", () => setStatus("Модель загружена ✅", true));
    mv.addEventListener("error", () => {
      setStatus("Не удалось загрузить модель/текстуры — показан Astronaut fallback.", false);
      setSrc(FALLBACK.glb, FALLBACK.usdz);
    });

    // Кнопки
    loadBtn.addEventListener("click", () => {
      setStatus("Загружаю…");
      setSrc(urlGlb.value.trim(), urlUsdz.value.trim());
    });

    astrBtn.addEventListener("click", () => {
      urlGlb.value = FALLBACK.glb;
      urlUsdz.value = FALLBACK.usdz;
      setStatus("Загружаю Astronaut (контрольный тест)...");
      setSrc(FALLBACK.glb, FALLBACK.usdz);
    });

    bustBtn.addEventListener("click", () => {
      if (!urlGlb.value) return;
      const g = withBust(urlGlb.value);
      const u = urlUsdz.value ? withBust(urlUsdz.value) : "";
      urlGlb.value = g;
      if (u) urlUsdz.value = u;
      setStatus("Сбрасываю кэш и перезагружаю…");
      setSrc(g, u);
    });

    // Мини-тесты (быстрые проверки)
    (function tests() {
      const mustHttp = (u) => /^https?:\\/\\//.test(u);
      console.assert(mustHttp(DEFAULTS.glb), "GLB по умолчанию должен быть http/https");
      console.assert(mustHttp(FALLBACK.glb), "Fallback GLB должен быть http/https");
    })();
  </script>
</body>
</html>
