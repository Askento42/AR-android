<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seven — 3D‑меню с AR</title>
  <meta name="description" content="Интерактивное меню ресторана Seven с 3D/AR моделями блюд." />
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root { --bg:#f6f2ed; --card:#ffffff; --text:#1b1b1b; --muted:#6b7280; --border:#e5e7eb; --accent:#7a2dff; --radius:16px; }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:#3b82f6;text-decoration:none}
    .container{max-width:1280px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .logo{display:flex;align-items:center;gap:12px;font-weight:800}
    .logo-badge{width:40px;height:40px;border-radius:12px;background:#1b1b1b;color:#fff;display:grid;place-items:center}
    .filters{display:flex;gap:8px;overflow-x:auto;padding:8px 0 16px}
    .chip{padding:8px 14px;border:1px solid var(--border);background:var(--card);border-radius:999px;cursor:pointer;white-space:nowrap}
    .chip.active{border-color:#1b1b1b;color:#1b1b1b}
    .layout{display:grid;grid-template-columns:380px 1fr;gap:20px}
    @media (max-width:980px){ .layout{grid-template-columns:1fr} }
    .list{display:grid;gap:12px}
    .item{display:grid;grid-template-columns:64px 1fr;gap:12px;align-items:center;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--card);cursor:pointer}
    .thumb{width:64px;height:64px;border-radius:12px;object-fit:cover;background:#eee}
    .meta h3{margin:0 0 4px 0;font-size:16px}
    .meta .sub{font-size:13px;color:var(--muted)}
    .viewer{border:1px solid var(--border);border-radius:16px;background:var(--card);padding:8px;min-height:360px;display:grid;align-items:center}
    .pad{padding:12px;border:1px solid var(--border);border-radius:16px;background:var(--card)}
    .titlebar{display:flex;justify-content:space-between;align-items:baseline;margin-top:12px}
    .price{font-weight:700}
    .controls{display:flex;gap:8px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--card);cursor:pointer}
    .btn.primary{background:#1b1b1b;color:#fff;border-color:#1b1b1b}
    .debug{position:fixed;top:10px;left:10px;background:#000;color:#fff;padding:4px 10px;border-radius:6px;font-size:14px;font-weight:700}
  </style>
</head>
<body>
  <div class="debug">СБОРКА V7</div>
  <div class="container">
    <header>
      <div class="logo"><div class="logo-badge">7</div><div>Seven — 3D‑меню с AR</div></div>
      <a class="btn" href="tel:+996555000777">Забронировать</a>
    </header>

    <div id="filters" class="filters"></div>

    <div class="layout">
      <div class="list" id="list"></div>
      <div class="pad">
        <div class="viewer" id="viewer">
          <div style="text-align:center;color:#9ca3af">Выберите блюдо слева</div>
        </div>
        <div class="titlebar">
          <h2 id="vt">—</h2>
          <div class="price" id="vp">—</div>
        </div>
        <div id="vd" style="color:#6b7280;margin-top:6px">—</div>
        <div class="controls">
          <a id="glb" class="btn" style="display:none" target="_blank">GLB</a>
          <a id="usdz" class="btn" style="display:none" target="_blank">USDZ</a>
          <button id="call" class="btn primary" onclick="location.href='tel:+996555000777'">Позвонить</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const TAJIN_MODEL = {
      glb: "https://askento42.github.io/AR-android/assets/models/soup.glb",
      usdz: "https://askento42.github.io/AR-android/assets/models/soup1.usdz"
    };
    const STATE = { data:null, cat:'Все', active:null };
    let POSTER_MAP = {};

    async function loadPosterMap(){
      try{
        const r = await fetch('./data/posters.json?_=' + Date.now());
        if(r.ok) POSTER_MAP = await r.json();
      }catch(e){}
    }

    function norm(x){
      const nx = {
        id: x.id || (x.title||x['название']||'').toLowerCase().replace(/\s+/g,'-'),
        title: x.title || x['название'] || 'Без названия',
        price: x.price ?? x['цена'] ?? null,
        currency: x.currency || x['валюта'] || 'сом',
        category: x.category || x['категория'] || 'Прочее',
        grams: x.grams || x['граммовка'] || x['вес'] || null,
        desc: x.desc || x['описание'] || x['desc'] || '',
        poster: x.poster || x['плакат'] || (POSTER_MAP[x.title] || null),
        badges: x.badges || x['значки'] || [],
        model: x.model || x['модель'] || null
      };
      const t = nx.title.trim().toLowerCase();
      if (!nx.model && (t.includes('таджин') || t.includes('tajin'))) {
        nx.model = { ...TAJIN_MODEL };
      }
      return nx;
    }

    function money(n, c){
      if(n==null) return '—';
      const map = { "сом":"KGS", "kgs":"KGS", "сомы":"KGS" };
      const code = (map[(c||'').toString().toLowerCase()] || c || "KGS");
      return new Intl.NumberFormat('ru-RU').format(n)+' '+code;
    }

    async function load(){
      await loadPosterMap();
      const url = './data/menu.json?v=prod&_=' + Date.now();
      const r = await fetch(url);
      const raw = await r.json();

      let itemsRaw = raw.items || raw['позиции'] || raw['предметы'] || raw['itemsList'] || [];
      if (!Array.isArray(itemsRaw) || itemsRaw.length === 0){
        const pools=[]; (function collect(o){ if(!o) return;
          if(Array.isArray(o)){ if(o.length && typeof o[0]==='object') pools.push(o); o.forEach(collect); }
          else if(typeof o==='object'){ Object.values(o).forEach(collect); }
        })(raw);
        pools.sort((a,b)=>b.length-a.length);
        for(const arr of pools){
          const ok = arr.some(o => (o && (o.title || o['название']) && (('цена' in o) || ('price' in o) || ('валюта' in o))));
          if (ok){ itemsRaw = arr; break; }
        }
      }

      const cats = (raw.categories || raw['категории'] || []).slice();
      const items = itemsRaw.map(norm);
      items.forEach(it => { if(it.category && !cats.includes(it.category)) cats.push(it.category); });

      STATE.data = { cats, items };
      renderFilters();
      renderList();
    }

    function renderFilters(){
      const root = document.getElementById('filters'); root.innerHTML='';
      const all = ['Все', ...STATE.data.cats];
      all.forEach(cat=>{
        const b=document.createElement('button');
        b.className='chip'+(STATE.cat===cat?' active':'');
        b.textContent=cat;
        b.onclick=()=>{ STATE.cat=cat; renderList(); };
        root.appendChild(b);
      });
    }

    function renderList(){
      const root=document.getElementById('list'); root.innerHTML='';
      const items = STATE.data.items.filter(x => STATE.cat==='Все' || x.category===STATE.cat);
      items.forEach(x=>{
        const el=document.createElement('div'); el.className='item';
        el.innerHTML = `
          <img class="thumb" src="${x.poster || ''}" alt="${x.title}">
          <div class="meta">
            <h3>${x.title}</h3>
            <div class="sub">${(x.grams||'').trim()} ${x.price!=null?' • '+money(x.price, x.currency):''}</div>
          </div>`;
        el.onclick=()=>openItem(x);
        root.appendChild(el);
      });
      if(items[0]) openItem(items[0]);
    }

    function openItem(x){
      STATE.active = x;
      document.getElementById('vt').textContent = x.title;
      document.getElementById('vp').textContent = x.price!=null ? money(x.price, x.currency) : '—';
      document.getElementById('vd').textContent = x.desc || '';
      const wrap=document.getElementById('viewer');
      if(x.model && x.model.glb && x.model.usdz){
        wrap.innerHTML = \`
        <model-viewer src="\${x.model.glb}" ios-src="\${x.model.usdz}" ar ar-modes="webxr scene-viewer quick-look"
          camera-controls auto-rotate shadow-intensity="1" exposure="1.1"
          style="width:100%;height:460px;background:#f6f2ed;border-radius:12px">
        </model-viewer>\`;
        const glb=document.getElementById('glb'); glb.style.display='inline-block'; glb.href=x.model.glb;
        const usdz=document.getElementById('usdz'); usdz.style.display='inline-block'; usdz.href=x.model.usdz;
      } else {
        wrap.innerHTML = \`<div style="text-align:center;color:#9ca3af; padding: 36px 0;">3D/AR недоступно для этого блюда</div>\`;
        document.getElementById('glb').style.display='none';
        document.getElementById('usdz').style.display='none';
      }
    }

    load();
  </script>
</body>
</html>