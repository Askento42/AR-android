<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seven — 3D‑меню (diagnostic)</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root { --bg:#f6f2ed; --card:#ffffff; --text:#1b1b1b; --muted:#6b7280; --border:#e5e7eb; --accent:#7a2dff; --radius:16px; }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .panel{border:1px solid var(--border);border-radius:12px;background:var(--card);padding:12px;margin-bottom:12px}
    pre{white-space:pre-wrap;word-break:break-word;background:#f3f4f6;padding:8px;border-radius:8px}
    .chip{display:inline-block;margin:4px 6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    .item{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px}
    .thumb{width:100%;height:120px;object-fit:cover;border-radius:8px;background:#eee}
  </style>
</head>
<body>
<div class="container">
  <div class="panel">
    <strong>Диагностика v4</strong>
    <div id="meta" style="margin-top:6px;color:#6b7280"></div>
  </div>
  <div class="panel"><div id="filters"></div></div>
  <div class="panel"><div id="list" class="list"></div></div>
  <div class="panel"><details><summary>Сырые ключи JSON</summary><pre id="keys"></pre></details></div>
  <div class="panel"><details><summary>Первые элементы</summary><pre id="first"></pre></details></div>
</div>

<script>
const TAJIN_MODEL = {
  glb: "https://askento42.github.io/AR-android/assets/models/soup.glb",
  usdz: "https://askento42.github.io/AR-android/assets/models/soup1.usdz"
};

function norm(x){
  const nx = {
    id: x.id || (x.title||x['название']||'').toLowerCase().replace(/\s+/g,'-'),
    title: x.title || x['название'] || 'Без названия',
    price: x.price ?? x['цена'] ?? null,
    currency: x.currency || x['валюта'] || 'сом',
    category: x.category || x['категория'] || 'Прочее',
    grams: x.grams || x['граммовка'] || x['вес'] || null,
    desc: x.desc || x['описание'] || x['desc'] || '',
    poster: x.poster || x['плакат'] || null,
    badges: x.badges || x['значки'] || [],
    model: x.model || x['модель'] || null
  };
  const t = nx.title.trim().toLowerCase();
  if (!nx.model && (t.includes('таджин') || t.includes('tajin'))) {
    nx.model = { ...TAJIN_MODEL };
  }
  return nx;
}

function collectArrays(obj, out){
  if (!obj) return;
  if (Array.isArray(obj)) {
    if (obj.length && typeof obj[0] === 'object') out.push(obj);
    obj.forEach(v => collectArrays(v, out));
  } else if (typeof obj === 'object') {
    Object.values(obj).forEach(v => collectArrays(v, out));
  }
}

function money(n, c){
  if(n==null) return '—';
  const map = { "сом":"KGS", "kgs":"KGS", "сомы":"KGS" };
  const code = (map[(c||'').toString().toLowerCase()] || c || "KGS");
  return new Intl.NumberFormat('ru-RU').format(n)+' '+code;
}

async function load(){
  const url = './data/menu.json?v=v4&_=' + Date.now();
  const r = await fetch(url);
  const raw = await r.json();
  const keys = Object.keys(raw);
  document.getElementById('keys').textContent = JSON.stringify(keys, null, 2);

  let itemsRaw = raw.items || raw['позиции'] || raw['предметы'] || raw['itemsList'] || [];
  if (!Array.isArray(itemsRaw) || itemsRaw.length === 0){
    const pools=[]; collectArrays(raw, pools);
    // pick the largest array of objects with title/цена hints
    pools.sort((a,b)=>b.length-a.length);
    for(const arr of pools){
      const hasDishHints = arr.some(o => (o && (o.title || o['название']) && (('цена' in o) || ('price' in o) || ('валюта' in o))));
      if (hasDishHints) { itemsRaw = arr; break; }
    }
  }
  const cats = (raw.categories || raw['категории'] || []).slice();
  const items = itemsRaw.map(norm);
  items.forEach(it => { if(it.category && !cats.includes(it.category)) cats.push(it.category); });

  document.getElementById('meta').textContent = `Загружено: категорий ${cats.length}, блюд ${items.length}. URL: ${url}`;
  document.getElementById('first').textContent = JSON.stringify(items.slice(0,4), null, 2);

  const froot = document.getElementById('filters'); froot.innerHTML='';
  ['Все', ...cats].forEach(cat => {
    const b=document.createElement('span'); b.className='chip'; b.textContent=cat; froot.appendChild(b);
  });

  const root = document.getElementById('list'); root.innerHTML='';
  items.forEach(x => {
    const el=document.createElement('div'); el.className='item';
    el.innerHTML = `
      <img class="thumb" src="${x.poster || ''}" alt="${x.title}">
      <div style="margin-top:8px;font-weight:700">${x.title}</div>
      <div style="color:#6b7280;font-size:13px">${(x.grams||'')}</div>
      <div style="margin-top:4px">${x.price!=null? money(x.price, x.currency): '—'}</div>`;
    root.appendChild(el);
  });
}

load();
</script>
</body>
</html>
