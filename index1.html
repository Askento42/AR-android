import React, { useEffect, useMemo, useRef, useState } from "react";
import "@google/model-viewer";

// ================================================
// AirMenu — React шаблон (v13, GLB-only)
// Изменения:
//  - Полностью убран USDZ/ios-src. Тестируем только GLB.
//  - Упрощена подстановка src для <model-viewer>.
//  - Оставлены категории и блюда как раньше, с 3D для «Суп Таджин».
//  - Fallback и cache-bust сохранены.
// ================================================

/** @typedef {{
  id: string,
  name: string,
  category: string,
  price?: string,
  weight?: string,
  desc?: string,
  poster?: string,
  glbSrc?: string,
  dimensions?: { w?: number; h?: number; l?: number; unit?: string },
}} Dish */

const brand = {
  name: "Seven",
  primary: "#511c28",
  surface: "#f6f3ef",
};

const categories = [
  "Салаты",
  "Закуски",
  "Супы",
  "Паста",
  "Основные блюда",
  "Пицца",
  "Десерты",
  "Гарниры",
];

// Публичный fallback (modelviewer.dev)
const FALLBACK = {
  glb: "https://modelviewer.dev/shared-assets/models/Astronaut.glb",
};

// ---- Утилиты ----
function isHttpUrl(u) {
  try { const x = new URL(u); return x.protocol === "http:" || x.protocol === "https:"; } catch { return false; }
}

function addCacheBust(url) {
  if (!url) return undefined;
  const buster = `v=${Date.now().toString().slice(0,10)}`;
  return url.includes("?") ? `${url}&${buster}` : `${url}?${buster}`;
}

function resolveGlbUrl(d /** @type {Partial<Dish>} */) {
  const glb = isHttpUrl(d.glbSrc) ? d.glbSrc : undefined;
  return addCacheBust(glb);
}

// ---- ДАННЫЕ МЕНЮ ----
/** @type {Dish[]} */
const initialDishes = [
  // САЛАТЫ
  { id: "salad-greco", name: "Греко", category: "Салаты", weight: "300 г", price: "690 с", poster: "https://images.unsplash.com/photo-1540420773420-3366772f4999?w=1200&q=80&auto=format", desc: "Классический греческий салат." },
  { id: "salad-green", name: "Зелёный салат", category: "Салаты", weight: "290 г", price: "680 с", poster: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=1200&q=80&auto=format" },
  { id: "salad-tabbouleh", name: "Табуле", category: "Салаты", weight: "300 г", price: "590 с", poster: "https://images.unsplash.com/photo-1543330463-8e62dbcad971?w=1200&q=80&auto=format" },
  { id: "salad-caesar", name: "Цезарь", category: "Салаты", weight: "330 г", price: "660 с", poster: "https://images.unsplash.com/photo-1551218808-94e220e084d2?w=1200&q=80&auto=format" },
  { id: "salad-salmon", name: "Салат с лососем", category: "Салаты", weight: "300 г", price: "890 с", poster: "https://images.unsplash.com/photo-1544025162-d76694265947?w=1200&q=80&auto=format" },
  { id: "salad-shrimp", name: "Салат с креветками", category: "Салаты", weight: "280 г", price: "790 с", poster: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=1200&q=80&auto=format" },
  { id: "salad-eggplant-strac", name: "Баклажаны со страчателлой", category: "Салаты", weight: "380 г", price: "740 с", poster: "https://images.unsplash.com/photo-1526312426976-593c2e615b8e?w=1200&q=80&auto=format" },
  { id: "salad-spicy-veal", name: "Острый салат из телятины", category: "Салаты", weight: "290 г", price: "840 с", poster: "https://images.unsplash.com/photo-1499028344343-cd173ffc68a9?w=1200&q=80&auto=format" },

  // ЗАКУСКИ / РОЛЛЫ
  { id: "roll-philadelphia", name: "Филадельфия", category: "Закуски", weight: "230 г", price: "790 с", poster: "https://images.unsplash.com/photo-1553621042-f6e147245754?w=1200&q=80&auto=format" },
  { id: "roll-shrimp-caviar", name: "Ролл с икоркой из креветок", category: "Закуски", weight: "280 г", price: "740 с", poster: "https://images.unsplash.com/photo-1593032457860-31e865b8d20f?w=1200&q=80&auto=format" },
  { id: "roll-baked-salmon", name: "Запечённый ролл с лососем", category: "Закуски", weight: "280 г", price: "820 с", poster: "https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?w=1200&q=80&auto=format" },
  { id: "roll-baked-eel", name: "Запечённый ролл с угрём", category: "Закуски", weight: "300 г", price: "820 с", poster: "https://images.unsplash.com/photo-1562158070-4e78c1e51b9e?w=1200&q=80&auto=format" },

  // СУПЫ (включая 3D)
  { id: "soup-tadjin", name: "Суп Таджин", category: "Супы", price: "—", weight: "—", desc: "Ароматный марокканский суп в тажине.", poster: "https://images.unsplash.com/photo-1625944525944-2e98f81dc1f8?w=1200&q=80&auto=format", glbSrc: "https://askento42.github.io/AR-android/scene.glb", dimensions: { w: 22, l: 22, h: 9, unit: "cm" } },
  { id: "soup-pumpkin", name: "Тыквенный суп", category: "Супы", weight: "350 г", price: "420 с", poster: "https://images.unsplash.com/photo-1547592180-85f173990554?w=1200&q=80&auto=format", desc: "Нежный крем-суп из тыквы." },
  { id: "soup-okroshka", name: "Окрошка с курицей", category: "Супы", weight: "450 г", price: "390 с", poster: "https://images.unsplash.com/photo-1525755662778-989d0524087e?w=1200&q=80&auto=format", desc: "Освежающий холодный суп." },
  { id: "soup-borscht", name: "Борщ", category: "Супы", weight: "450/40 г", price: "540 с", poster: "https://images.unsplash.com/photo-1551183053-bf91a1d81141?w=1200&q=80&auto=format", desc: "Классический борщ со сметаной." },
  { id: "soup-tom-yam", name: "Том-ям", category: "Супы", weight: "350/90 г", price: "820 с", poster: "https://images.unsplash.com/photo-1604908554049-1e32fba2d0f2?w=1200&q=80&auto=format", desc: "Кисло-острый суп с креветками и кокосовым молоком." },

  // ПАСТА
  { id: "pasta-carbonara", name: "Карбонара", category: "Паста", poster: "https://images.unsplash.com/photo-1523986371872-9d3ba2e2a389?w=1200&q=80&auto=format" },
  { id: "pasta-bolognese", name: "Болоньезе", category: "Паста", poster: "https://images.unsplash.com/photo-1529042410759-befb1204b468?w=1200&q=80&auto=format" },

  // ОСНОВНЫЕ БЛЮДА
  { id: "main-steak", name: "Стейк рибай", category: "Основные блюда", weight: "300 г", price: "1490 с", poster: "https://images.unsplash.com/photo-1551183053-bf91a1d81141?w=1200&q=80&auto=format", desc: "Сочный стейк средней прожарки с травами." },
  { id: "main-chicken", name: "Курица гриль", category: "Основные блюда", poster: "https://images.unsplash.com/photo-1544025162-d76694265947?w=1200&q=80&auto=format" },

  // ПИЦЦА
  { id: "pizza-margherita", name: "Маргарита", category: "Пицца", poster: "https://images.unsplash.com/photo-1548365328-8b849a3b9a02?w=1200&q=80&auto=format" },
  { id: "pizza-pepperoni", name: "Пепперони", category: "Пицца", poster: "https://images.unsplash.com/photo-1548365328-8b849a3b9a02?w=1200&q=80&auto=format" },

  // ДЕСЕРТЫ
  { id: "dessert-lemon-tart", name: "Лимонный тарт", category: "Десерты", weight: "120 г", price: "350 с", poster: "https://images.unsplash.com/photo-1519681393784-d120267933ba?w=1200&q=80&auto=format", desc: "Кисло-сладкий тарт с лимонным курдом." },
  { id: "dessert-cheesecake", name: "Чизкейк", category: "Десерты", poster: "https://images.unsplash.com/photo-1551024739-78e9d60c45ca?w=1200&q=80&auto=format" },

  // ГАРНИРЫ
  { id: "side-bread", name: "Хлеб", category: "Гарниры", poster: "https://images.unsplash.com/photo-1514511548155-21bcbf86fd16?w=1200&q=80&auto=format" },
  { id: "side-rice", name: "Рис", category: "Гарниры", poster: "https://images.unsplash.com/photo-1604908554049-1e32fba2d0f2?w=1200&q=80&auto=format" },
];

export default function AirMenuTemplate() {
  const [query, setQuery] = useState("");
  const [activeCat, setActiveCat] = useState("Супы"); // сразу открываем супы
  const [dishes] = useState(initialDishes);
  const [activeId, setActiveId] = useState(initialDishes.find((d) => d.category === "Супы")?.id);

  const mvRef = useRef(null);
  const [errorMsg, setErrorMsg] = useState("");
  const [isFallback, setIsFallback] = useState(false);

  // список блюд выбранной категории + поиск
  const withinCat = useMemo(() => dishes.filter((d) => d.category === activeCat), [dishes, activeCat]);
  const filtered = useMemo(() => {
    if (!query.trim()) return withinCat;
    const q = query.toLowerCase();
    return withinCat.filter((d) => [d.name, d.desc, d.price, d.weight].filter(Boolean).some((v) => String(v).toLowerCase().includes(q)));
  }, [withinCat, query]);

  const activeDish = useMemo(() => dishes.find((d) => d.id === activeId) ?? filtered[0] ?? withinCat[0], [activeId, dishes, filtered, withinCat]);

  useEffect(() => {
    // переключая категорию — ставим первое блюдо из неё
    const first = dishes.find((d) => d.category === activeCat);
    if (first) setActiveId(first.id);
  }, [activeCat, dishes]);

  // При любой ошибке загрузки <model-viewer> — мягкий fallback
  useEffect(() => {
    const el = mvRef.current;
    if (!el) return;
    const onError = () => {
      if (isFallback) return; // уже подставили
      setIsFallback(true);
      setErrorMsg("Не удалось загрузить 3D-модель/текстуры. Показан резервный образец. Проверьте публичный GLB и доступность файлов.");
      try { el.src = FALLBACK.glb; } catch {}
    };
    const onLoad = () => setErrorMsg("");
    el.addEventListener("error", onError);
    el.addEventListener("load", onLoad);
    return () => { el.removeEventListener("error", onError); el.removeEventListener("load", onLoad); };
  }, [isFallback, activeId]);

  // Подстановка URL в viewer (GLB-only)
  useEffect(() => {
    setIsFallback(false);
    setErrorMsg("");
    const el = mvRef.current;
    if (!el || !activeDish) return;
    const glb = resolveGlbUrl(activeDish);
    if (!glb) {
      setIsFallback(true);
      try { el.src = FALLBACK.glb; } catch {}
      return;
    }
    try { el.src = glb; } catch {}
  }, [activeDish]);

  // Мини-тесты
  ;(function tests() {
    console.assert(isHttpUrl(FALLBACK.glb) === true, "Fallback GLB должен быть валидным URL");
    console.assert(isHttpUrl("sandbox:/mnt/data/x") === false, "sandbox-пути недопустимы в браузере");
    const u = resolveGlbUrl({ glbSrc: "https://a.com/a.glb" }) || "";
    console.assert(/\?v=|&v=/.test(u), "Cache-buster должен добавляться к GLB");
    const tad = initialDishes.find(d => d.id === "soup-tadjin");
    const ru = resolveGlbUrl(tad || {});
    console.assert((ru || "").includes("askento42.github.io/AR-android/scene"), "GLB для Таджина должен вести на GitHub Pages");
  })();

  const currentGlb = activeDish ? resolveGlbUrl(activeDish) : undefined;

  return (
    <div style={{ minHeight: "100vh", background: brand.surface }}>
      {/* Header */}
      <header className="sticky top-0 z-30 flex items-center justify-between border-b bg-white/90 backdrop-blur px-4 py-3">
        <div className="flex items-center gap-3">
          <div className="h-9 w-9 rounded-xl" style={{ background: brand.primary, color: "#fff", display: "grid", placeItems: "center", fontWeight: 700 }}>7</div>
          <div className="font-semibold">Seven — 3D-меню (GLB-only)</div>
        </div>
        <div className="flex items-center gap-2">
          <input value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Поиск по блюдам…" className="hidden md:block w-64 rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
      </header>

      {/* Categories */}
      <div className="sticky top-[56px] z-20 bg-white border-b">
        <div className="mx-auto max-w-6xl px-3 py-2 flex gap-2 overflow-x-auto">
          {categories.map((c) => (
            <button key={c} onClick={() => setActiveCat(c)} className={`whitespace-nowrap rounded-full border px-3 py-1 text-sm ${activeCat === c ? "bg-indigo-600 text-white border-indigo-600" : "hover:bg-gray-50"}`}>{c}</button>
          ))}
        </div>
      </div>

      {/* Main layout */}
      <div className="mx-auto max-w-6xl grid grid-cols-1 lg:grid-cols-12 gap-0 p-3">
        {/* Sidebar */}
        <aside className="lg:col-span-4 border-r min-h-[calc(100vh-140px)] pr-3">
          <div className="mb-3 md:hidden">
            <input value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Поиск по блюдам…" className="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </div>
          <ul className="space-y-2 pr-1 overflow-y-auto max-h-[calc(100vh-180px)]">
            {filtered.map((d) => (
              <li key={d.id}>
                <button onClick={() => setActiveId(d.id)} className={`w-full rounded-xl border p-3 text-left hover:bg-gray-50 transition ${activeId === d.id ? "border-indigo-500 bg-indigo-50" : ""}`}>
                  <div className="flex items-center gap-3">
                    {d.poster ? <img src={d.poster} alt={d.name} className="h-14 w-14 rounded-lg object-cover" /> : <div className="h-14 w-14 rounded-lg bg-gray-200" />}
                    <div>
                      <div className="font-medium">{d.name}</div>
                      <div className="text-sm text-gray-600">{[d.weight, d.price].filter(Boolean).join(" • ")}</div>
                    </div>
                  </div>
                </button>
              </li>
            ))}
          </ul>
        </aside>

        {/* Viewer + details */}
        <section className="lg:col-span-8 min-h-[calc(100vh-140px)]">
          {activeDish && (
            <div className="grid grid-cols-1 xl:grid-cols-5 gap-6 h-full">
              {/* 3D viewer */}
              <div className="xl:col-span-3 flex flex-col rounded-2xl border p-3">
                {/* @ts-ignore */}
                <model-viewer
                  ref={mvRef}
                  src={currentGlb || FALLBACK.glb}
                  alt={activeDish.name}
                  ar
                  preload
                  ar-modes="webxr scene-viewer"
                  poster={activeDish.poster}
                  camera-controls
                  auto-rotate
                  shadow-intensity="0.8"
                  exposure="1"
                  style={{ width: "100%", height: 520, background: "#fff", borderRadius: 12 }}
                ></model-viewer>

                {errorMsg && (
                  <div className="mt-3 rounded-lg border border-red-300 bg-red-50 p-2 text-sm text-red-700">{errorMsg}</div>
                )}
              </div>

              {/* Details */}
              <div className="xl:col-span-2 flex flex-col rounded-2xl border p-4">
                <div className="flex items-start justify-between gap-4">
                  <div>
                    <h2 className="text-xl font-semibold">{activeDish.name}</h2>
                    <div className="text-indigo-600 font-medium mt-1">{[activeDish.weight, activeDish.price].filter(Boolean).join(" • ")}</div>
                  </div>
                </div>

                {activeDish.desc && (<p className="mt-4 text-gray-700 leading-relaxed">{activeDish.desc}</p>)}

                {activeDish.dimensions ? (
                  <div className="mt-4 text-sm text-gray-700">
                    Реальный размер (ориентир): {activeDish.dimensions.w ?? "?"}×{activeDish.dimensions.l ?? "?"}×{activeDish.dimensions.h ?? "?"} {activeDish.dimensions.unit ?? "cm"}
                  </div>
                ) : null}

                <div className="mt-auto pt-6 text-xs text-gray-500">
                  * Тест GLB-only. На iOS AR-кнопка может не работать без USDZ; просмотр 3D в браузере — работает.
                </div>
              </div>
            </div>
          )}
        </section>
      </div>
    </div>
  );
}
